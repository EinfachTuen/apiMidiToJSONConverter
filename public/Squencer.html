<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/sequencer.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<div id="whole page" width="100%">
    <button id="lastPage" style="display:none" onclick="lastPage()">last Page</button>
    <button id="nextPage" onclick="nextPage()">next Page</button>
    <div id="sequencer-table">
</div>
</div>
<script>
    let notes = [];
    let notePerTimeArray = [];
    let page = 1;
    let index = 0;
    let time = 0;
    let pageSteps =200;

    for(let i = 0; i<127; i++){
        notes[i] = false;
    }
    $.post( "/loadToText", function( data ) {
        console.log(data);
        notePerTimeArray = createNoteArray(data);
        createTable(notePerTimeArray);
    });
    function createNoteArray(data){
        let NoteArray = [];
        let actualTime = 0;
        data.forEach(event =>{
            actualTime += event.deltaTime;
            NoteArray.push({time:actualTime, notes:createNotes(event)});
        });
        return NoteArray;
    }
    function createNotes(event){
        if(event.subtype==="noteOn"){
            notes[event.noteNumber] = true;
        }
        if(event.subtype==="noteOff"){
            notes[event.noteNumber] = false;
        }
        return JSON.parse(JSON.stringify(notes));
    }
    function createTable(notePerTimeArray){
        let table = `<table>`;
        let BreakException = {};
        for(index; index < (pageSteps * page) && index < notePerTimeArray.length; index++){
            let NoteArray = notePerTimeArray[index];
            time = NoteArray.time;
            table += `<tr id="${time}"><td>${time}ms</td>`;
            index++;
            let noteNo = 0;
            NoteArray.notes.forEach(note => {
                noteNo++;
                if (!note) table += `<td id="${time}_${noteNo}"><div id="cell_${index}_${noteNo}" onClick="tableClick(${index},${noteNo})" style="height:15px; width:9px;background-color: white"></div>`;
                else table += `<td id="${time}_${noteNo}"><div id="cell_${index}_${noteNo}" onClick="tableClick(${index},${noteNo})" style="height:15px; width:9px;background-color: black"></div>`;
                table += `</td>`;
            });
            table += `</tr>`;
        }
        index = index - pageSteps;

        if(index > 0) document.getElementById("lastPage").style.display="inline";
        else document.getElementById("lastPage").style.display="none";

        table += `</table>`;
        document.getElementById('sequencer-table').innerHTML = table;
    }
    document.getElementById('sequencer-table').style.height = "900px";

    function tableClick(index,note) {
        console.log("index:"+index+" note:"+note);
        document.getElementById("cell_"+index+"_"+note).style["background-color"] = "black";
        notePerTimeArray[index][note-1] = true;
    }
    function nextPage(){
        page++;
        index = index+pageSteps;
        createTable(notePerTimeArray);
    }
    function lastPage(){
        page--;
        index = index - pageSteps;
        createTable(notePerTimeArray);
    }

</script>

</body>
</html>